<div class="container mt-4">
  <div class="card">
    <div class="card-header bg-success text-white">
      <h1>Order Confirmation #<%= @order.id %></h1>
    </div>
    <div class="card-body">
      <div class="alert alert-success">
        <h4 class="alert-heading">Thank you for your order!</h4>
        <p>Your order has been placed successfully.</p>
      </div>

      <div class="row mb-4">
        <div class="col-md-6">
          <h3>Order Details</h3>
          <p><strong>Status:</strong>
            <span class="badge bg-<%= @order.completed? ? 'success' : 'warning' %>">
              <%= @order.status.capitalize %>
            </span>
          </p>
          <p><strong>Date:</strong> <%= @order.created_at.strftime("%B %d, %Y %H:%M") %></p>
        </div>

        <div class="col-md-6">
          <h3>Shipping Address</h3>
          <p><%= simple_format(@order.shipping_address) %></p>

          <h3 class="mt-4">Billing Address</h3>
          <p><%= simple_format(@order.billing_address) %></p>

          <h5 class="mt-4">Province</h5>
          <p><%= @order.province %></p>
        </div>
      </div>

      <h3>Order Items</h3>
      <table class="table table-striped">
        <thead>
          <tr>
            <th>Book</th>
            <th>Quantity</th>
            <th>Price</th>
            <th>Line Total</th>
          </tr>
        </thead>
        <tbody>
          <% subtotal = 0 %>
          <% @order.order_items.each do |item| %>
            <% line_total = item.quantity * item.price %>
            <% subtotal += line_total %>
            <tr>
              <td><%= item.book.title %></td>
              <td><%= item.quantity %></td>
              <td><%= number_to_currency(item.price) %></td>
              <td><%= number_to_currency(line_total) %></td>
            </tr>
          <% end %>
        </tbody>
        <tfoot>
          <tr>
            <th colspan="3" class="text-end">Subtotal:</th>
            <th><%= number_to_currency(subtotal) %></th>
          </tr>

          <%# Dynamic tax calculation based on province %>
          <% rates = tax_rates_for(@order.province) %>
          <% gst = subtotal * rates[:gst] %>
          <% pst = subtotal * rates[:pst] %>
          <% hst = subtotal * rates[:hst] %>
          <% total = subtotal + gst + pst + hst %>

          <% if gst > 0 %>
            <tr>
              <th colspan="3" class="text-end">GST (<%= (rates[:gst] * 100).to_i %>%):</th>
              <th><%= number_to_currency(gst) %></th>
            </tr>
          <% end %>

          <% if pst > 0 %>
            <tr>
              <th colspan="3" class="text-end">PST (<%= (rates[:pst] * 100).to_i %>%):</th>
              <th><%= number_to_currency(pst) %></th>
            </tr>
          <% end %>

          <% if hst > 0 %>
            <tr>
              <th colspan="3" class="text-end">HST (<%= (rates[:hst] * 100).to_i %>%):</th>
              <th><%= number_to_currency(hst) %></th>
            </tr>
          <% end %>

          <tr class="table-success">
            <th colspan="3" class="text-end">Total (Including Taxes):</th>
            <th><%= number_to_currency(total) %></th>
          </tr>
        </tfoot>
      </table>

      <%= link_to "Back to Books", books_path, class: "btn btn-primary" %>
    </div>
  </div>
</div>
